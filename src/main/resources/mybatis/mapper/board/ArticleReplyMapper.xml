<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nooblol.board.mapper.ArticleReplyMapper">
  <insert id="upsertReply" parameterType="ReplyDto">
    INSERT INTO bbs_articles_reply(reply_id, article_id, reply_content, status, sort_no,
                                   created_user_id, created_at)
    VALUES (#{replyId}, #{articleId}, #{replyContent}, #{status}, #{sortNo}, #{createdUserId},
            #{createdAt}) ON DUPLICATE KEY
    UPDATE
      reply_content = IFNULL(VALUES (reply_content), reply_content)
      , status = IFNULL(VALUES (status), status)
  </insert>

  <select id="selectMaxReplyId" resultType="int">
    SELECT COALESCE(MAX(reply_id) + 1, 1)
    FROM bbs_articles_reply
  </select>

  <select id="selectMaxSortNoByArticleId" parameterType="int" resultType="int">
    SELECT COALESCE(MAX(sort_no) + 1, 1)
    FROM bbs_articles_reply
    WHERE article_id = #{articleId}
  </select>

  <select id="selectCreatedUserIdByReplyId" parameterType="int" resultType="String">
    SELECT created_user_id
    FROM bbs_articles_reply
    WHERE reply_id = #{replyId}
  </select>

  <delete id="deleteReplyByReplyId" parameterType="int">
    DELETE
    FROM bbs_articles_reply
    WHERE reply_id = #{replyId}
  </delete>

  <delete id="deleteReplyByArticleId" parameterType="int">
    DELETE
    FROM bbs_articles_reply
    WHERE article_id = #{articleId}
  </delete>

  <select id="selectReplyByReplyId" parameterType="int" resultType="ReplyDto">
    SELECT reply_id,
           article_id,
           reply_content,
           status,
           sort_no,
           created_at,
           created_user_id,
           created_at
    FROM bbs_articles_reply
    WHERE reply_id = #{replyId}
  </select>

  <select id="selectReplyListByArticleId" parameterType="int" resultType="ReplyDto">
    SELECT reply_id,
           article_id,
           reply_content,
           status,
           sort_no,
           created_at,
           created_user_id,
           created_at
    FROM bbs_articles_reply
    WHERE article_id = #{articleId}
    ORDER BY sort_no
  </select>
</mapper>